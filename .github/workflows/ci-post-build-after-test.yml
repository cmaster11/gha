# This workflow need to be invoked by any test workflow, after all other jobs
# are completed.
name: CI - After test / Finalize status checks

on:
  workflow_call:
    inputs:
      needs-json:
        description: Pass toJSON(needs) to this input
        required: true
        type: string

jobs:
  finalize-check:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/github-script@v7
        env:
          NEEDS_JSON: ${{ inputs.needs-json }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha || github.sha }}
        with:
          script: |
            const { NEEDS_JSON, GITHUB_WORKFLOW_REF, HEAD_SHA } = process.env;
            if (NEEDS_JSON == null) {
              throw new Error('needs-json input not found.');
            }
            if (GITHUB_WORKFLOW_REF == null) {
              throw new Error('GITHUB_WORKFLOW_REF environment variable not defined.');
            }
            if (HEAD_SHA == null) {
              throw new Error('HEAD_SHA environment variable not defined.');
            }

            // Find at least one failed job in the "needs" context
            const needs = JSON.parse(NEEDS_JSON);
            const anyFailed = Object.entries(needs)
              .find(([k,v]) => v.result == 'failure') != null;

            // cmaster11/gha/.github/workflows/test.yml@refs/heads/main
            // cmaster11/gha/.github/workflows/test.yml
            // test.yml
            const name = GITHUB_WORKFLOW_REF.split('@')[0].split('/').reverse()[0];

            // Finalize the status check for the workflow
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name,
              status: 'completed',
              conclusion: anyFailed ? 'failure' : 'success',
              head_sha: HEAD_SHA,
            })
